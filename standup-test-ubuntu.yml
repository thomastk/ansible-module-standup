# Playbook to smoke test standup module, to verify a new installation or test code changes in the module.
# Needs verify-cluster-checks.yml in the same directory where this playbook is run from,
#or, adjust the paths suitably.
---
- name: standup-test
  hosts: all
  become: yes
  tasks:
      - name:Setup test bed - install mysql and Apache
        apt: name=mysql-server,apache2

      - name: Setup test bed - start mysql
        service: name=mysql state=started

      - name: Setup test bed - start Apache
        service: name=apache2 state=started

      - name: Copy checks input file to remote host
        copy: 
           src: verify-cluster-checks-ubuntu.yml 
           dest: /tmp/verify-cluster-checks.yml 

      - name: Run only db and web related checks 
        standup: 
           checks_file_path: /tmp/verify-cluster-checks.yml 
           roles: web,db
        register: output_web_mysql
        ignore_errors: true
      
      - debug: var=output_web_mysql

      - name: Run all the checks 
        standup: 
           checks_file_path: /tmp/verify-cluster-checks.yml
        register: output_all
        ignore_errors: true
          
      - debug: var=output_all

      - name: Stop mysql service so following task will run heal step
        service: name=mysql state=stopped

      - name: Run db and web related checks with heal option enabled
        standup: 
           heal_state: true
           checks_file_path: /tmp/verify-cluster-checks.yml 
           roles: web,db
        register: output_heal
        ignore_errors: true

      - debug: var=output_heal

